# Caddyfile — used by docker-compose.https.yml for automatic HTTPS
#
# For production: set APP_DOMAIN in your environment
# For local dev with HTTPS: set APP_DOMAIN=localhost (uses Caddy's local CA)
#
# Usage:
#   APP_DOMAIN=catlife.example.com docker-compose -f docker-compose.yml -f docker-compose.https.yml up

{$APP_DOMAIN} {
    # Automatically provisions a TLS certificate (Let's Encrypt in prod,
    # local CA for localhost)

    # ── Blocages de sécurité (évalués avant le reverse_proxy) ─────────────

    # Bloquer l'accès direct à la base de données SQLite
    @database path /database /database/*
    respond @database 403

    # Bloquer les fichiers PHP dans uploads/ (protection webshell)
    @uploads_php {
        path /uploads/*
        path_regexp ext \.(php\d*|phtml|phps)$
    }
    respond @uploads_php 403

    reverse_proxy app:80

    # ── Security headers ──────────────────────────────────────────────────
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options   "nosniff"
        X-Frame-Options          "DENY"
        Referrer-Policy          "strict-origin-when-cross-origin"
        Content-Security-Policy  "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: blob:; connect-src 'self'"
        # Masquer la stack technique
        -Server
    }

    # Cache static assets aggressively
    @static path /icons/* /style.css /sw.js /manifest.json
    header @static Cache-Control "public, max-age=31536000, immutable"

    # Compress responses
    encode gzip
}
